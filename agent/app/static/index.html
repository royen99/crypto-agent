<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agent Runner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            orange: { 500: '#ff6200', 600: '#ff4d00' }
          }
        }
      }
    };
  </script>
</head>
<body class="bg-neutral-950 text-neutral-100 min-h-screen">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-4">
      <span class="text-orange-500">✦</span> Autonomous Agent MVP
    </h1>

    <div class="bg-neutral-900/70 border border-neutral-800 rounded-lg p-4 mb-4">
      <label class="block text-sm mb-2">Goal</label>
      <textarea id="goal" class="w-full p-3 rounded bg-neutral-950 border border-neutral-800 focus:outline-none"
        rows="3" placeholder="e.g., Analyze BTCUSDT, ETHUSDT on 1h. For each: run mexc_ta, give BUY/HOLD/SELL + brief reasons. Then save a note titled 'mexc ideas'."></textarea>
      <div class="mt-3 flex gap-2">
        <button id="startBtn"
          class="px-4 py-2 rounded bg-orange-500 hover:bg-orange-600 font-semibold">Start Run</button>
        <span id="status" class="text-sm text-neutral-400"></span>
      </div>
    </div>

    <div class="bg-neutral-900/70 border border-neutral-800 rounded-lg p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Live Log</h2>
        <button id="clearBtn" class="text-xs px-2 py-1 border border-neutral-700 rounded">Clear</button>
      </div>
      <div id="log" class="text-sm font-mono whitespace-pre-wrap h-40 overflow-auto"></div>
    </div>
  </div>

<div class="mt-6 bg-neutral-900/70 border border-neutral-800 rounded-lg p-4">
  <div class="flex flex-wrap items-end gap-3 mb-3">
    <h2 class="font-semibold mr-auto">Market Recommendations</h2>

    <label class="text-sm">
      Interval
      <select id="rec-interval" class="ml-2 bg-neutral-950 border border-neutral-800 rounded px-2 py-1">
        <option value="1m">1m</option>
        <option value="5m">5m</option>
        <option value="15m">15m</option>
        <option value="30m">30m</option>
        <option value="60m" selected>60m</option>
        <option value="4h">4h</option>
        <option value="1d">1d</option>
        <option value="1W">1W</option>
        <option value="1M">1M</option>
      </select>
    </label>

    <label class="text-sm">
      Symbols (optional)
      <input id="rec-symbols" placeholder="BTCUSDT,ETHUSDT"
             class="ml-2 bg-neutral-950 border border-neutral-800 rounded px-2 py-1"/>
    </label>

    <button id="rec-refresh"
            class="px-3 py-2 rounded bg-orange-500 hover:bg-orange-600 font-semibold">Refresh</button>
    <span id="rec-status" class="text-sm text-neutral-400"></span>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full text-sm">
    <thead class="text-neutral-300">
    <tr class="border-b border-neutral-800">
        <th class="text-left py-2 pr-4">Symbol</th>
        <th class="text-left py-2 pr-4">Price</th>
        <th class="text-left py-2 pr-4">Price ▵</th>
        <th class="text-left py-2 pr-4">24h %</th>
        <th class="text-left py-2 pr-4">RSI14</th>
        <th class="text-left py-2 pr-4">MACD Hist</th>
        <th class="text-left py-2 pr-4">Score</th>
        <th class="text-left py-2 pr-4">Score ▵</th>
        <th class="text-left py-2 pr-4">Recommendation</th>
        <th class="text-left py-2 pr-4">Reasons</th>
    </tr>
    </thead>
    <tbody id="rec-tbody"></tbody>
    </table>
  </div>
</div>


  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');

    function addLine(obj) {
      const t = new Date().toLocaleTimeString();
      logEl.textContent += `[${t}] ${JSON.stringify(obj)}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    document.getElementById('clearBtn').onclick = () => { logEl.textContent = ''; };

    document.getElementById('startBtn').onclick = async () => {
      const goal = document.getElementById('goal').value.trim();
      if (!goal) return;
      statusEl.textContent = 'Starting…';

      const res = await fetch('/runs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ goal })
      });
      const data = await res.json();
      const runId = data.id;
      statusEl.textContent = `Run ${runId} queued`;

      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(`${proto}://${location.host}/ws/runs/${runId}`);
      ws.onopen = () => addLine({ type: 'ws', msg: 'connected' });
      ws.onmessage = (ev) => {
        const msg = JSON.parse(ev.data);
        addLine(msg);
        if (msg.type === 'final') statusEl.textContent = '✅ finished';
        if (msg.type === 'error') statusEl.textContent = '⚠️ error';
      };
      ws.onclose = () => addLine({ type: 'ws', msg: 'closed' });
    };
  </script>

<script>
  function badge(text, kind) {
    const base = "px-2 py-1 text-xs font-semibold rounded";
    const map = {
      BUY: "bg-green-600/70 text-white",
      ACCUMULATE: "bg-emerald-600/70 text-white",
      HOLD: "bg-neutral-700/70 text-neutral-100",
      "AVOID/SELL": "bg-red-600/80 text-white",
      UNKNOWN: "bg-neutral-700/70 text-neutral-100"
    };
    return `<span class="${base} ${map[kind] || map.UNKNOWN}">${text}</span>`;
  }

  function changeFmt(v) {
    if (v === null || v === undefined || isNaN(v)) return "—";
    const s = Number(v).toFixed(2);
    const cls = v > 0 ? "text-green-400" : (v < 0 ? "text-red-400" : "text-neutral-300");
    return `<span class="${cls}">${s}%</span>`;
  }

  function renderRecs(data) {
    const tbody = document.getElementById('rec-tbody');
    const status = document.getElementById('rec-status');
    tbody.innerHTML = '';

    (data.results || []).forEach(r => {
      const rec = r.recommendation || 'UNKNOWN';
      const ds = (r.delta_score?.toFixed ? r.delta_score.toFixed(2) : (r.delta_score ?? "—"));
      const dp = (r.delta_price?.toFixed ? r.delta_price.toFixed(6) : (r.delta_price ?? "—"));
      const dsCls = r.delta_score > 0 ? "text-green-400" : (r.delta_score < 0 ? "text-red-400" : "text-neutral-300");
      const dpCls = r.delta_price > 0 ? "text-green-400" : (r.delta_price < 0 ? "text-red-400" : "text-neutral-300");

      const tr = document.createElement('tr');
      tr.className = "border-b border-neutral-900 hover:bg-neutral-900/40";
        tr.innerHTML = `
        <td class="py-2 pr-4 font-mono">${r.symbol}</td>
        <td class="py-2 pr-4">
            ${r.price?.toFixed ? r.price.toFixed(6) : r.price ?? "—"}
        </td>
        <td class="py-2 pr-4">
            <div id="spark-price-${r.symbol}" class="w-28 h-7"></div>
        </td>
        <td class="py-2 pr-4">${changeFmt(r.change24h)}</td>
        <td class="py-2 pr-4">${r.rsi14?.toFixed ? r.rsi14.toFixed(1) : "—"}</td>
        <td class="py-2 pr-4">${r.macd_hist?.toFixed ? r.macd_hist.toFixed(6) : "—"}</td>
        <td class="py-2 pr-4">
            ${r.score?.toFixed ? r.score.toFixed(2) : "—"}
        </td>
        <td class="py-2 pr-4">
            <div id="spark-score-${r.symbol}" class="w-28 h-7"></div>
        </td>
        <td class="py-2 pr-4">${badge(rec, rec)}</td>
        <td class="py-2 pr-4 text-neutral-300">${(r.reasons||[]).join("; ") || "—"}</td>
        `;

      tbody.appendChild(tr);
    });

    status.textContent = `auto · ${data.interval} · as of ${new Date(data.as_of || Date.now()).toLocaleTimeString()} · ${data.results?.length||0} symbols`;
    refreshSparklines(data.interval);
    }

  async function loadRecs() {
    const interval = document.getElementById('rec-interval').value;
    const symbols = document.getElementById('rec-symbols').value.trim();
    const status = document.getElementById('rec-status');
    status.textContent = 'Loading…';

    const qs = new URLSearchParams({ interval });
    if (symbols) qs.set('symbols', symbols);

    const res = await fetch(`/recommendations?${qs.toString()}`);
    const data = await res.json();
    renderRecs(data);
  }

  // manual button still works
  document.getElementById('rec-refresh').onclick = loadRecs;

  // 🔌 subscribe to server-pushed snapshots
  (function connectRecsWS() {
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${proto}://${location.host}/ws/recs`);
    ws.onopen = () => console.log('[recs] ws connected');
    ws.onmessage = (ev) => {
      try {
        const msg = JSON.parse(ev.data);
        if (msg.type === 'recs' && msg.data) renderRecs(msg.data);
      } catch {}
    };
    ws.onclose = () => {
      console.warn('[recs] ws closed; retrying in 3s');
      setTimeout(connectRecsWS, 3000);
    };
  })();

  // initial fill (in case WS hasn’t pushed yet)
  loadRecs();

function sparklineSVG(vals, {width=112, height=28, strokeWidth=2, padding=2}={}){
  const w = width, h = height, pad = padding;
  const xs = vals.filter(v => v !== null && v !== undefined);
  if (!xs.length) return `<svg width="${w}" height="${h}"></svg>`;
  const min = Math.min(...xs), max = Math.max(...xs);
  const rng = (max - min) || 1;

  const step = (w - pad*2) / Math.max(vals.length - 1, 1);
  const points = vals.map((v, i) => {
    const x = pad + i*step;
    const y = v == null ? null : (h - pad - ((v - min)/rng) * (h - pad*2));
    return [x, y];
  });

  // build path (skip nulls)
  let d = "";
  for (let i=0;i<points.length;i++){
    const [x,y] = points[i];
    if (y == null) continue;
    const cmd = d ? "L" : "M";
    d += `${cmd}${x.toFixed(1)},${y.toFixed(1)} `;
  }

  // last value dot
  const last = [...points].reverse().find(([x,y]) => y != null);

  return `
  <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
    <path d="${d.trim()}" fill="none" stroke="currentColor" stroke-width="${strokeWidth}" opacity="0.9"/>
    ${last ? `<circle cx="${last[0].toFixed(1)}" cy="${last[1].toFixed(1)}" r="2.5" fill="currentColor" />` : ""}
  </svg>`;
}

async function refreshSparklines(interval){
  // collect symbols in the table
  const syms = [...document.querySelectorAll('#rec-tbody tr td:first-child')].map(td => td.textContent.trim());
  if (!syms.length) return;

  const qs = new URLSearchParams({ interval, symbols: syms.join(','), points: 48 });
  const res = await fetch(`/recs/history?${qs.toString()}`);
  const data = await res.json();

  const series = data.series || {};
  syms.forEach(sym => {
    const row = series[sym];
    if (!row) return;
    const priceEl = document.getElementById(`spark-price-${sym}`);
    const scoreEl = document.getElementById(`spark-score-${sym}`);
    if (priceEl) priceEl.innerHTML = sparklineSVG(row.price);
    if (scoreEl) scoreEl.innerHTML = sparklineSVG(row.score);
  });
}

</script>

</body>
</html>
